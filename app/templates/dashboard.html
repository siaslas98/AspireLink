<!-- app/templates/dashboard.html -->
{% extends "base.html" %}

{% block head_extra %}
<style>
  /* hide FullCalendar's internal scrollbars */
  #calendar .fc-scroller-liquid,
  #calendar .fc-scrollgrid-liquid {
    overflow-y: hidden !important;
  }

  /* calendar container styling */
  .calendar-container {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    scroll-margin-top: 100px;
  }

  /* toolbar layout: left buttons, centered title, right button */
  .fc .fc-header-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1rem;
    background-color: #1e1e1e;
    border-radius: 6px;
    margin-bottom: 1rem;
  }
  .fc .fc-toolbar-chunk:nth-child(2) {
    flex: 1;
    display: flex;
    justify-content: flex-start;
    padding-left: 12rem;
  }
  /* toolbar button styling */
  .fc .fc-button {
    background-color: #2e2e2e;
    color: #fff;
    border: none;
    border-radius: 4px;
    margin: 0 0.25rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
  }
  .fc .fc-button:hover {
    background-color: #3e3e3e;
  }

  /* centered title with no transform */
  .fc .fc-toolbar-title {
    font-size: 1.5rem;
    margin: 0;
  }

  /* header cells styling */
  #calendar .fc-col-header-cell {
    background-color: #2a2a2a;
    color: #ddd;
    font-weight: bold;
    padding: 0.5rem 0;
  }

  /* larger day numbers */
  #calendar .fc-daygrid-day-number {
    font-size: 1.2rem;
    padding: 0.5rem;
  }

  /* hover effect */
  #calendar .fc-daygrid-day:hover {
    background-color: rgba(0, 191, 166, 0.1);
  }

  /* check-in button styling */
  .checkin-button {
    margin: 1.5rem 0;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    background-color: #00bfa6;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .checkin-button:disabled {
    opacity: 0.6;
    cursor: default;
  }

  #notifications {
    position: fixed;
    top: 1rem;
    right: 1rem;
    width: 320px;
    z-index: 1000;
  }

  .notification {
    background-color: #2a2a2a;
    border-left: 4px solid #7cc4b1;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    color: #d3f3ee;
    font-size: 0.95rem;
    line-height: 1.4;
  }

  .notification-content a {
    color: #7cc4b1;
    text-decoration: underline;
    display: inline-block;
    margin-top: 0.5rem;
    font-weight: 500;
  }

  .notification-content button {
    float: right;
    background: none;
    border: none;
    color: #d3f3ee90;
    font-size: 1.1rem;
    cursor: pointer;
    margin-left: 0.5rem;
  }
  .notification-content button:hover {
    color: #fcd3de;
  }

  /* Badge Styling */
  .badges-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
  }

  .badge-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    background-color: #2a2a2a;
    border-radius: 8px;
    border-left: 4px solid #7cc4b1;
    gap: 1rem;
  }

  .badge-emoji {
    font-size: 2rem;
    flex-shrink: 0;
  }

  .badge-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .badge-info strong {
    color: #d3f3ee;
    font-size: 1.1rem;
  }

  .badge-info small {
    color: #d3f3ee80;
    font-size: 0.9rem;
  }

  .next-badge {
    margin-top: 1.5rem;
    padding: 1rem;
    background-color: #1e1e1e;
    border-radius: 8px;
    border: 2px solid #7cc4b140;
  }

  .next-badge h4 {
    margin-bottom: 0.5rem;
    color: #7cc4b1;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background-color: #3a3a3a;
    border-radius: 4px;
    overflow: hidden;
    margin: 0.5rem 0;
  }

  .progress-fill {
    height: 100%;
    background-color: #7cc4b1;
    transition: width 0.3s ease;
    border-radius: 4px;
  }

  /* Reminder form styling - consistent with rest of app */
  .reminder-form {
    background-color: #2a2a2a;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }

  .reminder-form h4 {
    margin-bottom: 1rem;
    color: #7cc4b1;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    color: #d3f3ee;
  }

  .form-group input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #444;
    background-color: #1e1e1e;
    color: #fff;
    border-radius: 4px;
    font-size: 1rem;
  }

  .form-submit {
    padding: 0.75rem 2rem;
    background-color: #7cc4b1;
    color: #1e1e1e;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
  }

  /* Reminder list styling - consistent with badges */
  .reminders-list {
    background-color: #2a2a2a;
    padding: 1.5rem;
    border-radius: 8px;
  }

  .reminders-list h4 {
    margin-bottom: 1rem;
    color: #7cc4b1;
  }

  .reminder-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    background-color: #1e1e1e;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    gap: 1rem;
  }

  .reminder-item.overdue {
    border-left: 4px solid #ff6b6b;
  }

  .reminder-item.due-soon {
    border-left: 4px solid #ffd93d;
  }

  .reminder-item.upcoming {
    border-left: 4px solid #7cc4b1;
  }

  .reminder-info {
    flex: 1;
    display: grid;
    grid-template-columns: 2fr 2fr 1.5fr 1fr;
    gap: 1rem;
    align-items: center;
  }

  .reminder-company {
    color: #d3f3ee;
    font-weight: 500;
  }

  .reminder-role {
    color: #d3f3ee;
  }

  .reminder-date {
    color: #d3f3ee;
  }

  .reminder-status.overdue {
    color: #ff6b6b;
    font-weight: bold;
    font-size: 0.9rem;
  }

  .reminder-status.due-soon {
    color: #ffd93d;
    font-weight: bold;
    font-size: 0.9rem;
  }

  .reminder-status.upcoming {
    color: #7cc4b1;
    font-size: 0.9rem;
  }

  .reminder-action button {
    background-color: #7cc4b1;
    color: #1e1e1e;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
  }
</style>
{% endblock %}

{% block dashboard %}
  <div id="notifications" class="notifications-container"></div>

  <div class="calendar-container" id="calendar-container">
    <h1>Welcome, {{ user.username }}!</h1>
    <div id="calendar"></div>
    <button onclick="checkInToday()" class="checkin-button">
      Check In Today
    </button>
  </div>

  {# profile #}
  <div id="profile">
  <h2>My Profile</h2>
  
  <!-- Badges -->
  <section>
    <h3>My Badges ({{ user_badges|length }})</h3>
    {% if user_badges %}
    <div class="badges-container">
      {% for badge in user_badges %}
      <div class="badge-item">
        <span class="badge-emoji">{{ badge.emoji }}</span>
        <div class="badge-info">
          <strong>{{ badge.badge_name }}</strong>
          <small>{{ badge.badge_description }}</small>
          <small>Earned: {{ badge.earned_at.strftime("%Y-%m-%d") }}</small>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p>No badges earned yet. Keep earning points to unlock badges!</p>
    {% endif %}
    
    <!-- Next Badge Progress -->
    {% set next_badge = (all_badge_info | selectattr('points', 'gt', user.points) | first) %}
    
    {% if next_badge %}
    <div class="next-badge">
      <h4>Next Badge: {{ next_badge.emoji }} {{ next_badge.name }}</h4>
      <p>{{ next_badge.description }}</p>
      <div class="progress-bar">
        <div class="progress-fill" style="width: {{ (user.points / next_badge.points * 100)|round(1) }}%"></div>
      </div>
      <small>{{ user.points }} / {{ next_badge.points }} points</small>
    </div>
    {% endif %}
  </section>
  
  <!-- Watchlist -->
  <section>
    <h3>Watchlist ({{ stats.watchlist_count }})</h3>
    {% if watchlist %}
    <ul>
      {% for item in watchlist %}
      <li>
        {{ item.company_name }}
        <small>added on {{ item.added_at.strftime("%Y-%m-%d") }}</small>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p>You haven't added any companies yet.</p>
    {% endif %}
  </section>
  </div>

  {# application logs #}
  <div id="app-logs">
  <!-- Application Logs -->
  <section style="margin-top: 2rem">
    <h3>Application Logs ({{ stats.application_count }})</h3>
    {% if application_logs %}
    <table>
      <thead>
        <tr>
          <th>Company</th>
          <th>Role</th>
          <th>Status</th>
          <th>Date Applied</th>
        </tr>
      </thead>
      <tbody>
        {% for log in application_logs %}
        <tr>
          <td>{{ log.company }}</td>
          <td>{{ log.role }}</td>
          <td>{{ log.status }}</td>
          <td>{{ log.date_applied.strftime("%Y-%m-%d") }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No applications logged yet.</p>
    {% endif %}
  </section>
  </div>

  <!-- quick Stats -->
  <div id="quick-stats">
  <section style="margin-top: 2rem">
    <h3>Quick Stats</h3>
    <ul>
      <li>Total in Watchlist: {{ stats.watchlist_count }}</li>
      <li>Total Applications: {{ stats.application_count }}</li>
      <li>Points: {{stats.points}}</li>
    </ul>
  </section>
  </div>

  {# reminders #}
  <div id="reminders">
    <section style="margin-top: 2rem">
      <h3>Application Reminders</h3>
      
      <!-- Add New Reminder Form -->
      <div class="reminder-form">
        <h4>Add New Reminder</h4>
        <form action="/add_reminder" method="post">
          <div class="form-row">
            <div class="form-group">
              <label for="company">Company *</label>
              <input type="text" name="company" id="company" required placeholder="e.g., Google">
            </div>
            <div class="form-group">
              <label for="role">Role *</label>
              <input type="text" name="role" id="role" required placeholder="e.g., Software Engineer Intern">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="due_date">Application Deadline *</label>
              <input type="date" name="due_date" id="due_date" required>
            </div>
            <div class="form-group" style="align-self: end;">
              <button type="submit" class="form-submit">Add Reminder</button>
            </div>
          </div>
        </form>
      </div>

      <!-- Current Reminders -->
      <div class="reminders-list">
        <h4>My Reminders ({{ reminders|length }})</h4>
        
        {% if reminders %}
          {% for reminder in reminders %}
          <div class="reminder-item 
                      {% if reminder.due_date <= today %}overdue
                      {% elif reminder.due_date <= (today + timedelta(days=3)) %}due-soon
                      {% else %}upcoming{% endif %}">
            
            <div class="reminder-info">
              <div class="reminder-company">{{ reminder.company }}</div>
              <div class="reminder-role">{{ reminder.role }}</div>
              <div class="reminder-date">{{ reminder.due_date.strftime("%Y-%m-%d") }}</div>
              <div class="reminder-status 
                          {% if reminder.due_date <= today %}overdue
                          {% elif reminder.due_date <= (today + timedelta(days=3)) %}due-soon
                          {% else %}upcoming{% endif %}">
                {% if reminder.due_date <= today %}
                  OVERDUE
                {% elif reminder.due_date <= (today + timedelta(days=3)) %}
                  DUE SOON
                {% else %}
                  Upcoming
                {% endif %}
              </div>
            </div>
            
            <div class="reminder-action">
              <form action="/complete_reminder" method="post">
                <input type="hidden" name="reminder_id" value="{{ reminder.id }}">
                <button type="submit" onclick="return confirm('Mark this reminder as complete?')">
                  Complete
                </button>
              </form>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div style="text-align: center; padding: 2rem; color: #d3f3ee80;">
            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">ðŸ“… No reminders set yet</p>
            <p style="font-size: 0.9rem;">Add a reminder above to track your application deadlines!</p>
          </div>
        {% endif %}
      </div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
<script>
  let shownNotifications = JSON.parse(
    localStorage.getItem("shownNotifications") || "[]"
  );
  const checkinData = {{ checkins | tojson }};

  async function checkNotifications() {
    try {
      const res = await fetch("/api/notifications", {
      credentials: "include",
      });
      const data = await res.json();
      if (data.new_internships?.length) {
        const newOnes = data.new_internships.filter(
          i => !shownNotifications.includes(i.id)
        );
        if (newOnes.length) {
          showNotifications(newOnes);
          shownNotifications.push(...newOnes.map(i => i.id));
          localStorage.setItem(
            "shownNotifications",
            JSON.stringify(shownNotifications)
          );
        }
      }
    } catch (err) {
      console.log("Error checking notifications:", err);
    }
  }
  
  function showNotifications(items) {
    const container = document.getElementById("notifications");
    items.forEach(item => {
      const n = document.createElement("div");
      n.className = "notification";
      n.innerHTML = `<div class="notification-content">
        <strong>New Internship!</strong><br>
        <strong>${item.company}</strong> - ${item.role}<br>
        <small>${item.location || "Remote"}</small>
        <button onclick="this.parentElement.parentElement.remove()">Ã—</button>
      </div>`;
      container.appendChild(n);
      setTimeout(() => n.remove(), 8000);
    });
  }

  async function checkInToday() {
    const res = await fetch("/api/checkin", { method: "POST" });
    document.querySelector(".checkin-button").disabled = true;

    if (res.ok) {
      const data = await res.json();
      let alertMessage = `Check-in successful! You now have ${data.points} points.`;
      
      if (data.new_badges && data.new_badges.length > 0) {
        const badgeNames = data.new_badges.map(badge => `${badge.emoji} ${badge.name}`).join(', ');
        alertMessage += `\n\nðŸŽ‰ New badge(s) earned: ${badgeNames}!`;
      }
      
      alert(alertMessage);
      document.querySelector("#quick-stats li:last-child").textContent = `Points: ${data.points}`;

      if (window.calendar) calendar.refetchEvents();
      
      if (data.new_badges && data.new_badges.length > 0) {
        setTimeout(() => window.location.reload(), 2000);
      }
    } else {
      const data = await res.json();
      alert(data.message || "Checkâ€‘in failed.");
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById("calendar");
    window.calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      headerToolbar: {
        left: "today prev,next",
        center: "title",
        right: ""
      },
      height: "auto",
      contentHeight: 800,
      aspectRatio: 1.8,
      dayMaxEvents: true,
      events: checkinData.map(c => ({
        start: new Date(c.date).toISOString().split("T")[0],
        allDay: true,
        display: "background",
        backgroundColor: "#00bfa6"
      }))
    });
    calendar.render();

    // Set minimum date to today for reminder form
    const dueDateInput = document.getElementById('due_date');
    const today = new Date().toISOString().split('T')[0];
    dueDateInput.min = today;

    checkNotifications();
    setInterval(checkNotifications, 30000);
  });
</script>
{% endblock %}
