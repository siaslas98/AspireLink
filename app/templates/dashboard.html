{% extends "base.html" %} {% block content %}
<div id="notifications"></div>

<h1>Welcome, {{ user.username }}!</h1>

<div class="checkin-container">
<h2 class="checkins">Check-Ins</h2>
<div id="calendar"></div><br>
<button onclick="checkInToday()">Check In Today</button>

{# <ul>
{% for checkin in checkins %}
  <li>{{ checkin.user_id|e }}</li>
  <li>{{ checkin.note|e }}</li>
  <li>{{ checkin.date|e }}</li>
{% endfor %}
</ul> #}
</div>

<script>
  let lastCheck = localStorage.getItem("lastNotificationCheck") || "0";
  let shownNotifications = JSON.parse(
    localStorage.getItem("shownNotifications") || "[]"
  );
  const checkinData = {{ checkins | tojson }};

  async function checkNotifications() {
    try {
      const response = await fetch("/api/notifications");
      const data = await response.json();

      if (data.new_internships && data.new_internships.length > 0) {
        const newOnes = data.new_internships.filter(
          (internship) => !shownNotifications.includes(internship.id)
        );

        if (newOnes.length > 0) {
          showNotifications(newOnes);
          shownNotifications.push(...newOnes.map((i) => i.id));
          localStorage.setItem(
            "shownNotifications",
            JSON.stringify(shownNotifications)
          );
        }
      }
    } catch (error) {
      console.log("Error checking notifications:", error);
    }
  }

  function showNotifications(internships) {
    const container = document.getElementById("notifications");

    internships.forEach((internship) => {
      const notification = document.createElement("div");
      notification.className = "notification";
      notification.innerHTML = `
          <div class="notification-content">
            <strong>New Internship!</strong><br>
            <strong>${internship.company}</strong> - ${internship.role}<br>
            <small>${internship.location || "Remote"}</small>
            ${
              internship.link
                ? `<a href="${internship.link}" target="_blank">Apply</a>`
                : ""
            }
            <button onclick="this.parentElement.parentElement.remove()">Ã—</button>
          </div>
        `;
      container.appendChild(notification);

      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 8000);
    });
  }

  checkNotifications();
  setInterval(checkNotifications, 30000);
  
  async function checkInToday() {
    const res = await fetch("/api/checkin", { method: "POST" });
    document.querySelector('button').disabled = true; 

    if (res.ok) {
      alert("Checked in!");
      calendar.refetchEvents(); // Refresh calendar events if you're using event source
    } else {
      const data = await res.json();
      alert(data.message || "Check-in failed.");
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    window.calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
        events: checkinData.map(c => ({
        start: new Date(c.date).toISOString().split('T')[0],
        allDay: true,
        display: 'background',
        backgroundColor: '#00bfa6',
      }))
    });
    calendar.render();
  });

</script>

<style>
  #notifications {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    width: 300px;
  }

  .notification {
    background: #2196f3;
    color: white;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    animation: slideIn 0.3s ease-out;
  }

  .notification-content {
    position: relative;
  }

  .notification button {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    font-size: 12px;
  }

  .notification a {
    color: white;
    text-decoration: underline;
    margin-left: 10px;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  .checkin-container{
    padding: 2rem;
    display: flex;
    flex-direction: column;
  }
  #calendar {
    width: 60%;
    margin: auto;
  }

  .checkin-container button{
    margin-top: 50px;
    width: 50%;
    margin: 50px auto; 
  }
</style>
{% endblock %}
